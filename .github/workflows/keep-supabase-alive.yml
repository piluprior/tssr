name: Maintenir Supabase actif
# Ce workflow empÃªche Supabase de se mettre en veille aprÃ¨s 7 jours d'inactivitÃ©

on:
  schedule:
    # S'exÃ©cute le lundi et jeudi Ã  8h00 UTC (9h00 heure de Paris)
    - cron: '0 8 * * 1,4'

  workflow_dispatch:
    # Permet de dÃ©clencher manuellement le workflow depuis l'interface GitHub

jobs:
  ping-supabase:
    runs-on: ubuntu-latest

    steps:
      - name: VÃ©rifier la connexion Supabase
        run: |
          echo "ğŸ”„ Ping de Supabase pour maintenir l'activitÃ©..."

          # Effectue une simple requÃªte GET sur la table cv_downloads
          # Limite Ã  1 ligne pour minimiser les donnÃ©es transfÃ©rÃ©es
          http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -X GET "${{ secrets.SUPABASE_URL }}/rest/v1/cv_downloads?select=id&limit=1" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}")

          echo "ğŸ“¡ Code HTTP reÃ§u: $http_code"

          # VÃ©rifie si la requÃªte a rÃ©ussi (code 200)
          if [ "$http_code" = "200" ]; then
            echo "âœ… Supabase est actif"
            echo "ğŸ“… Date: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          else
            echo "âŒ Erreur lors de la connexion Ã  Supabase (Code HTTP: $http_code)"
            echo "ğŸ” VÃ©rifiez que le projet Supabase est actif et que les secrets GitHub sont correctement configurÃ©s"
            exit 1
          fi
