name: Maintenir Supabase actif
# Ce workflow emp√™che Supabase de se mettre en veille apr√®s 7 jours d'inactivit√©

on:
  schedule:
    # S'ex√©cute tous les 3 jours √† 9h00 UTC (10h00 heure de Paris)
    - cron: '0 9 */3 * *'

  workflow_dispatch:
    # Permet de d√©clencher manuellement le workflow depuis l'interface GitHub

jobs:
  ping-supabase:
    runs-on: ubuntu-latest

    steps:
      - name: Maintenir l'activit√© de la base de donn√©es
        run: |
          echo "üîÑ Op√©ration d'activit√© sur Supabase pour √©viter la pause..."

          # V√©rification que les secrets sont bien d√©finis
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "‚ùå ERREUR: Le secret SUPABASE_URL n'est pas d√©fini"
            exit 1
          fi

          if [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "‚ùå ERREUR: Le secret SUPABASE_ANON_KEY n'est pas d√©fini"
            exit 1
          fi

          echo "‚úì Secrets GitHub d√©tect√©s"
          echo "üì° Tentative d'INSERT dans la table heartbeat..."

          # Effectue un INSERT dans la table heartbeat (op√©ration d'√©criture r√©elle)
          # Cela compte comme une vraie activit√© de base de donn√©es
          timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/heartbeat" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{\"pinged_at\":\"$timestamp\",\"source\":\"github-actions\"}")

          echo "üì° Code HTTP re√ßu: $http_code"

          if [ "$http_code" = "201" ] || [ "$http_code" = "200" ]; then
            echo "‚úÖ INSERT r√©ussi - Supabase actif"
            echo "üìÖ Timestamp: $timestamp"
          else
            echo "‚ö†Ô∏è Code HTTP inattendu: $http_code"
            echo "üîç V√©rifications:"
            echo "   - Le projet Supabase doit √™tre actif (pas en pause)"
            echo "   - La table 'heartbeat' doit exister"
            echo "   - Les permissions d'INSERT doivent √™tre configur√©es"
            exit 1
          fi
