name: Maintenir Supabase actif
# Ce workflow emp√™che Supabase de se mettre en veille apr√®s 7 jours d'inactivit√©

on:
  schedule:
    # S'ex√©cute le lundi et jeudi √† 8h00 UTC (9h00 heure de Paris)
    - cron: '0 8 * * 1,4'

  workflow_dispatch:
    # Permet de d√©clencher manuellement le workflow depuis l'interface GitHub

jobs:
  ping-supabase:
    runs-on: ubuntu-latest

    steps:
      - name: V√©rifier la connexion Supabase
        run: |
          echo "üîÑ Ping de Supabase pour maintenir l'activit√©..."

          # Effectue une simple requ√™te GET sur la table cv_downloads
          # Limite √† 1 ligne pour minimiser les donn√©es transf√©r√©es
          response=$(curl -s -w "\n%{http_code}" \
            -X GET "${{ secrets.SUPABASE_URL }}/rest/v1/cv_downloads?select=id&limit=1" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}")

          # S√©pare le code HTTP du corps de la r√©ponse
          http_code=$(echo "$response" | tail -n1)

          # V√©rifie si la requ√™te a r√©ussi (code 200)
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Supabase est actif (Code HTTP: $http_code)"
            echo "üìÖ Date: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          else
            echo "‚ùå Erreur lors de la connexion √† Supabase (Code HTTP: $http_code)"
            exit 1
          fi
